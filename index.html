<!DOCTYPE HTML>
<html>

<head>
	<title>Польовик</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script> <!-- MQTT over WebSocket -->
	<style>
		/* Paste all your original CSS from WEBPAGE.h here */
		/* (same styles for buttons, slider, map, etc.) */
		html {
			font-family: Arial;
			background: #000;
			color: #efefef;
			text-align: center;
		}

		body {
			max-width: 600px;
			margin: 0 auto;
			padding-bottom: 25px;
		}

		button {
			width: 100px;
			height: 60px;
			font-size: 21px;
			background: #4247b7;
			color: white;
			border-radius: 5px;
			margin: 5px;
		}

		button:hover {
			background: #ff494d;
		}

		#position-slider {
			width: 100%;
			height: 40px;
			background: linear-gradient(to right, #333, #4247b7, #333);
			border-radius: 20px;
		}

		#position-slider::-webkit-slider-thumb {
			width: 50px;
			height: 50px;
			background: #ff494d;
			border: 4px solid white;
			border-radius: 50%;
		}

		#map {
			height: 300px;
			width: 100%;
			margin: 20px auto;
			border: 3px solid #4247b7;
			border-radius: 10px;
		}

		/* ... add the rest of your CSS ... */
	</style>
</head>

<body>
	<h3>Польовик Remote</h3>
	<div id="STSValue">Connecting...</div>
	<p>
		<button onmousedown="sendJog('minus', 'start')" onmouseup="sendJog('minus', 'stop')"
			ontouchstart="sendJog('minus', 'start')" ontouchend="sendJog('minus', 'stop')">&lt;-</button>
		<button onclick="sendCommand('center')">Центр</button>
		<button onmousedown="sendJog('plus', 'start')" onmouseup="sendJog('plus', 'stop')"
			ontouchstart="sendJog('plus', 'start')" ontouchend="sendJog('plus', 'stop')">-&gt;</button>
	</p>
	<p>
		<button onclick="sendCommand('speed_plus')">Speed+</button>
		<button onclick="sendCommand('speed_minus')">Speed-</button>
	</p>
	<div id="slider-container">
		<input type="range" id="position-slider" min="0" max="4095" value="2047">
	</div>
	<input type="number" id="position-input" min="0" max="4095" value="2047">
	<p id="current-pos">Поточна позиція: 0°</p>
	<div id="map"></div>

	<script>
		// === MQTT Connection ===
		const client = mqtt.connect('wss://940d7f06dbf1455c841afb26f9c5cf1c.s1.eu.hivemq.cloud:8884/mqtt', {
			username: 'Werden',
			password: 'Sec@#21Werden'
		})

		client.on('connect', () => {
			document.getElementById("STSValue").innerHTML = "MQTT Connected!"
			client.subscribe('Werden/status')
		})

		client.on('message', (topic, message) => {
			if (topic === 'Werden/status') {
				const data = JSON.parse(message.toString())
				const raw = data.raw || 2047
				const deg = Math.round((raw - 2047) * 360 / 4095)

				document.getElementById("STSValue").innerHTML =
					`ID: ${data.id} | Raw: ${raw} | ${deg}°<br>` +
					`Нап: ${data.volt}V | Нав: ${data.load}% | Швид: ${data.speed}<br>` +
					`Темп: ${data.temp}°C | Вст.швид: ${data.set_speed}`

				document.getElementById("position-slider").value = raw
				document.getElementById("position-input").value = raw
				document.getElementById("current-pos").textContent = `Поточна позиція: ${deg}°`
				updateMapDirection(deg)
			}
		})

		// === Commands ===
		function sendPosition(pos) {
			client.publish('Werden/command/position', pos.toString())
		}

		function sendCommand(cmd) {
			client.publish('Werden/command/' + cmd, 'go')
		}

		function sendJog(dir, state) {
			client.publish('Werden/command/jog_' + dir, state)
		}

		// Slider
		document.getElementById('position-slider').addEventListener('input', function () {
			sendPosition(this.value)
			document.getElementById("position-input").value = this.value
		})

		document.getElementById('position-input').addEventListener('change', function () {
			let val = Math.max(0, Math.min(4095, parseInt(this.value)))
			document.getElementById("position-slider").value = val
			sendPosition(val)
		})

		// === Map ===
		let map, marker, arrow
		function initMap() {
			const lat = 48.904339, lng = 37.605560
			map = L.map('map').setView([lat, lng], 16)
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
			marker = L.marker([lat, lng]).addTo(map).bindPopup('Польовик').openPopup()
			arrow = L.polyline([], { color: 'red', weight: 8 }).addTo(map)
			updateMapDirection(0)
		}

		function updateMapDirection(deg) {
			const center = marker.getLatLng()
			const distance = 0.001
			const rad = deg * Math.PI / 180
			const endLat = center.lat + distance * Math.cos(rad)
			const endLng = center.lng + distance * Math.sin(rad) / Math.cos(center.lat * Math.PI / 180)
			arrow.setLatLngs([[center.lat, center.lng], [endLat, endLng]])
		}

		window.onload = initMap;
	</script>
</body>

</html>